# This file defines the CI/CD pipeline to build and deploy the application

steps:
  # Build the main image, but push the image to gcr
  - name: 'gcr.io/cloud-builders/docker'
    id: Building the base program image
    args: [
      'build',
      '-t',
      'gcr.io/development-303600/data_funnel:pre_tag',
      '--cache-from', 'gcr.io/development-303600/data_funnel:pre_tag',
      '.'
    ]

  # Build the tests image
  - name: 'gcr.io/cloud-builders/docker'
    id: Building the tests program image
    args: [
      'build',
      '-t',
      'gcr.io/development-303600/data_funnel_test',
      '--cache-from', 'gcr.io/development-303600/data_funnel_test:pre_tag,
      '.'
    ]

#   Check the code quality
  - name: 'gcr.io/development-303600/data_funnel_test'
    id: Checking code quality with pylint
    entrypoint: "/bin/sh"
    args: [ "tests/pylint_check.sh" ]

  # Run the unit tests
  - name: 'gcr.io/development-303600/data_funnel_test'
    id: Running Unit Tests
    args: ['/data_funnel/tests/run_tests.sh']

  # Re-tag the image
  - name: 'gcr.io/cloud-builders/docker'
    id: Tag the main docker image
    args: [ 'tag', 'gcr.io/development-303600/data_funnel:pre_tag', 'gcr.io/development-303600/data_funnel:$COMMIT_SHA' ]

  # Push the image
  - name: 'gcr.io/cloud-builders/docker'
    id: Push the docker image
    args: [ 'push', 'gcr.io/development-303600/data_funnel:$COMMIT_SHA' ]

#  # Deploy the container image to Cloud Run
#  - name: 'gcr.io/cloud-builders/gcloud'
#    id: Deploy the container image to Cloud Run
#    args:
#      - 'run'
#      - 'deploy'
#      - 'data-funnel'
#      - '--image'
#      - 'gcr.io/development-303600/data_funnel:$COMMIT_SHA'
#      - '--region'
#      - 'us-central1'
#      - '--platform'
#      - 'managed'

options:
  logging: CLOUD_LOGGING_ONLY
#
#images:
#- 'gcr.io/weather-website-255501/data_funnel:$COMMIT_SHA'